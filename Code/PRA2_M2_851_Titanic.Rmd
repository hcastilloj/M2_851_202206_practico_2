---
title: 'M2.851 - Tipología y ciclo de vida de los datos: Practico 2'
author: "Autores: Gabriel Álvarez Morgado y Héctor Alejandro Castillo Jeria"
date: "Junio 2022"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: UOC-header.html
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
editor_options: 
  markdown: 
    wrap: 72
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

------------------------------------------------------------------------

# Introducción

Este documento contiene el desarrollo del Práctico número 2, en el cual, se elabora un caso práctico orientado a aprender a identificar los datos relevantes para un proyecto analítico y usar las herramientas de integración, limpieza, validación y análisis de las mismas.

------------------------------------------------------------------------

# Competencias

En esta práctica se desarrollan las siguientes competencias del Máster de Data Science:

> Capacidad de analizar un problema en el nivel de abstracción adecuado a cada situación 
y aplicar las habilidades y conocimientos adquiridos para abordarlo y resolverlo.
>
> Capacidad para aplicar las técnicas específicas de tratamiento de datos (integración, 
transformación, limpieza y validación) para su posterior análisis

------------------------------------------------------------------------


# Objetivos

Los objetivos concretos de esta práctica son:

> Aprender a aplicar los conocimientos adquiridos y su capacidad de resolución de problemas en entornos nuevos o poco conocidos dentro de contextos más amplios o multidisciplinares.
>
> Saber identificar los datos relevantes y los tratamientos necesarios (integración, limpieza 
y validación) para llevar a cabo un proyecto analítico.
>
> Aprender a analizar los datos adecuadamente para abordar la información contenida en los datos.
>
> Identificar la mejor representación de los resultados para aportar conclusiones sobre el problema planteado en el proceso analítico.
>
> Actuar con los principios éticos y legales relacionados con la manipulación de datos en función del ámbito de aplicación.
>
> Desarrollar las habilidades de aprendizaje que les permitan continuar estudiando de un modo que tendrá que ser en gran medida autodirigido o autónomo.
>
> Desarrollar la capacidad de búsqueda, gestión y uso de información y recursos en el ámbito de la ciencia de datos. 

------------------------------------------------------------------------

# Importancia de los análisis

A partir de este conjunto de datos se plantea la problemática de determinar qué variables son las que más influyen en la sobrevivencia o no de los pasajeros del RMS Titanic.

Además, se pretende crear modelos predictivos para emplearlos en el set de datos de test y determinar las probabilidades de que un pasajero pueda o no sobrevivir a la tragedia.

------------------------------------------------------------------------

# Inicio de Actividad.

## Comprensión de los datos.

La muestra con la que trabajaremos corresponde a los datos de pasajeros del **RMS Titanic**, famoso transatlantico que sufre un accidente y se hunde en su viaje inaugural, el día 15 de Abril de 1912, donde fallecen 1502 de sus 2224 pasajeros y tripulantes.

Este juego de datos se encuentra en los archivos **train.csv** y **test.csv** ambos archivos, obtenido desde Kaggle **"Titanic - Machine Learning from Disaster"** <https://www.kaggle.com/competitions/titanic>

El archivo **train.csv** posee la información de los pasajeros, lo que permitirá entrenar nuestro modelo, para emplear luego el archivo **test.csv** que contiene información de pasajeros, para predecir si los pasajeros de esta muestra sobreviven al hundimiento del Titanic, de acuerdo a ciertos factores que obtendremos en el desarrollo de práctico.

## Carga de librerias y fichero de datos.

Instalamos y cargamos las librerías necesarias para desarrollar el práctico.

```{r echo=TRUE, message=FALSE, warning=FALSE}

librerias = c("ggplot2", "dplyr", "knitr", "grid", "gridExtra", "ggstatsplot",
              "car","rpart","rpart.plot","caret")

for (lib in librerias){
  if (!require(lib, character.only = TRUE)){
    install.packages(lib)
    library(lib, character.only = TRUE)
  } 
}
```

Cargamos los ficheros de datos *train.csv* y *test.csv*.

```{r}
trainData = read.csv('train.csv',stringsAsFactors = FALSE)
testData  = read.csv('test.csv' ,stringsAsFactors = FALSE)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
filasTrain  = dim(trainData)[1]
columTrain = length(trainData)
filasTest  = dim(testData)[1]
columTest  = length(testData)

```



## Exploración de la base de datos de **test**

Calcularemos las dimensiones de nuestra base de datos y analizaremos qué tipos de atributos tenemos.

```{r}
dim(testData)
```

Mediante la función dim(), vemos que tenemos `r filasTest` registros (filas) que se corresponden a las reseñas y `r columTest` variables (columnas) que los caracterizan.

Verificamos la estructura del juego de datos principal.

```{r}
str(testData)
```

Revisamos la descripción de las variables contenidas al fichero y si los
tipos de variable se corresponde al que hemos cargado:


 **Atributo**    |    **Descripción**   
-----------------|--------------------------------------------------------------------------
 **PassengerId** | Número Identificador del pasajero 
 **Pclass** | Clase Pasajero (1=primera Clase; 2=Segunda Clase; 3=Tercera Clase) 
 **Name** | Nombre 
 **Sex** | Sexo 
 **Age** | Edad 
 **SibSp** | Número de hermanos/cónyuges a bordo 
 **Parch** | Número de padres/hijos a bordo 
 **Ticket** | Número de Ticket 
 **Fare** | Tarifa de pasajero 
 **Cabin** | Cabina 
 **Embarked** | Puerto de embarque (C=Cherbourg; Q=Queenstown; S=Southampton) 


Obtendremos estadísticas básicas, para luego trabajar con los atributos que no poseen valores o se encuentran vacíos.

Estadísticas básicas

```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(testData)
```

Como parte de la exploración de los datos, verificaremos si hay valores perdidos.

```{r}
colSums(is.na(testData) | testData=="")
```

Podemos observar que hay 86 datos faltantes en la variable Age, 327 en el atributo cabin y 1 en Fare.

Las estadísticas obtenidas indican lo siguiente sobre la data:

> El atributo **Age**, posee 86 datos vacíos, como este dato es relevante, el atributo no será eliminado y serán imputados los valores faltantes según el promedio de la edad de los pasajeros, dependiendo del sexo, la clase, su estado de sobrevivencia y las variables familiares SibSp y Parch.
> 
> El atributo **Fare**, posee 1 dato vacío, se cargará el promedio por defecto.
> 
> El atributo **Cabin**, posee 327 datos vacíos, este dato no es relevante y se eliminará el atributo.
> 
> El atributo **Name**, este dato no es relevante y se eliminará el atributo.
> 
> El atributo **PassengerId**, este dato no es relevante y se eliminará el atributo.


## Exploración de la base de datos de **train**

Calcularemos las dimensiones de nuestra base de datos y analizaremos qué tipos de atributos tenemos.

```{r}
dim(trainData)
```

Mediante la función dim(). Obtenemos que disponemos de `r length(trainData$PassengerId)` registros (filas) y `r length(trainData)` variables (columnas). 

Verificamos la estructura del juego de datos principal.

```{r}
str(trainData)
```


Revisamos la descripción de las variables contenidas al fichero y si los
tipos de variable se corresponde al que hemos cargado:

 **Atributo**    |    **Descripción**   
-----------------|--------------------------------------------------------------------------
 **PassengerId** | Número Identificador del pasajero 
 **Survived** | Sobreviviente (0=No; 1=Si)
 **Pclass** | Clase Pasajero (1=primera Clase; 2=Segunda Clase; 3=Tercera Clase) 
 **Name** | Nombre 
 **Sex** | Sexo 
 **Age** | Edad 
 **SibSp** | Número de hermanos/cónyuges a bordo 
 **Parch** | Número de padres/hijos a bordo 
 **Ticket** | Número de Ticket 
 **Fare** | Tarifa de pasajero 
 **Cabin** | Cabina 
 **Embarked** | Puerto de embarque (C=Cherbourg; Q=Queenstown; S=Southampton) 


Obtendremos estadísticas básicas, para luego trabajar con los atributos que no poseen valores o se encuentran vacíos.

Estadísticas básicas

```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(trainData)
```

Como parte de la exploración de los datos, verificaremos si hay valores perdidos.

```{r}
colSums(is.na(trainData) | trainData=="")
```

Podemos observar que hay 177 datos faltantes en la variable Age, 687 en el atributo cabin y 2 en Embarked.


> El atributo **Age**, posee 177 datos vacíos, como este dato es relevante, el atributo no será eliminado y serán imputados los valores faltantes según el promedio de la edad de los pasajeros, dependiendo del sexo, la clase, su estado de sobrevivencia y las variables familiares SibSp y Parch.
> 
> El atributo **Cabin**, posee 687 datos vacíos, este dato no es relevante y se eliminará el atributo.
> 
> El atributo **Embarked**, posee 2 datos vacíos, se cargará un valor por defecto correspondiente a la moda de la variable.
> 
> El atributo **Name**, este dato no es relevante y se eliminará el atributo.
> 
> El atributo **PassengerId**, este dato no es relevante y se eliminará el atributo.


------------------------------------------------------------------------


## Preparación de los datos.

En este paso realizaremos la normalización de algunos atributos, la clusterización de otros, la eliminación de datos no relevantes, la creación de nuevos atributos, basicamente en este punto tomamos el set de datos, para luego aplicar tecnicas de normalización, completar atributos inexistentes, agregar valores por defecto, incorporar un atributo empleando formulas estadisticas como la media. Como ejemplo. En este punto, a los atributos de tipo texto, le cargaremos el valor por defecto "desconocido", cuando el atributo es nulo o vacío.



### Reemplazo de valores nulos o vacíos.

Reemplazo de la edad en trainData

```{r}
for(i in seq(nrow(trainData))){
  if(is.na(trainData$Age[i])){
    sim_age = trainData$Age[trainData$Survived==trainData$Survived[i] &
                              trainData$Pclass==trainData$Pclass[i] &
                              trainData$Sex==trainData$Sex[i] &
                              trainData$SibSp==trainData$SibSp[i] &
                              trainData$Parch==trainData$Parch[i]]
    if(is.na(mean(sim_age, na.rm = TRUE))){
      trainData$Age[i] = mean(trainData$Age, na.rm = TRUE)
    } else {
      trainData$Age[i] = mean(sim_age, na.rm = TRUE)
    }
  }
}
```

Reemplazo de la edad en testData

```{r}
for(i in seq(nrow(testData))){
  if(is.na(testData$Age[i])){
    sim_age = testData$Age[testData$Survived==testData$Survived[i] &
                              testData$Pclass==testData$Pclass[i] &
                              testData$Sex==testData$Sex[i] &
                              testData$SibSp==testData$SibSp[i] &
                              testData$Parch==testData$Parch[i]]
    if(is.na(mean(sim_age, na.rm = TRUE))){
      testData$Age[i] = mean(testData$Age, na.rm = TRUE)
    } else {
      testData$Age[i] = mean(sim_age, na.rm = TRUE)
    }
  }
}
```

Reemplazo de la variable Embarked en trainData y de la variable Fare en testData

```{r}
trainData$Embarked[trainData$Embarked==""] = "S"
testData$Fare[is.na(testData$Fare)] = mean(testData$Fare, na.rm = TRUE)
```

Verificación de corrección de valores vacíos en **train** y **test**.

```{r}
colSums(is.na(testData) | testData=="")
colSums(is.na(trainData) | trainData=="")
```

Se visualizan valores faltantes solo en la variable Cabin que será eliminada posteriormente.

## Identificación de valores atípicos en trainData

Se observará la presencia de valores extremos o atípicos en las variables numéricas a través del método propuesto por Tukey. Se partirá con la edad:

```{r}
q = quantile(trainData$Age,seq(0.25,0.75,0.25))
RIC =  q[3] - q[1]
LI = q[1] - 1.5*RIC
LS = q[3] + 1.5*RIC

atip = length(trainData$Age[trainData$Age<LI | trainData$Age>LS])

paste0("Para la variable Age, hay ", atip, " valores atípicos que se encuentran fuera del intervalo (",LI,",",LS,")")
```

Hay 28 datos atípicos en la variable Age, sin embargo se ha decidido no eliminarlos ni trabajarlos como valroes faltantes, puesto que corresponden a edades correctas que posiblemente hayan tenido algunas personas. Como la gran mayoría de los pasajeros eran personas jóvenes, se identifica como valores atípicos aquellas edades más avanzadas.

Ahora pasaremos a las variables familiares SibSP y Parch

```{r}
q = quantile(trainData$SibSp,seq(0.25,0.75,0.25))
RIC =  q[3] - q[1]
LI = q[1] - 1.5*RIC
LS = q[3] + 1.5*RIC

atip = length(trainData$SibSp[trainData$SibSp<LI | trainData$SibSp>LS])

paste0("Para la variable SibSp, hay ", atip, " valores atípicos que se encuentran fuera del intervalo (",LI,",",LS,")")

q = quantile(trainData$Parch,seq(0.25,0.75,0.25))
RIC =  q[3] - q[1]
LI = q[1] - 1.5*RIC
LS = q[3] + 1.5*RIC

atip = length(trainData$Parch[trainData$Parch<LI | trainData$Parch>LS])

paste0("Para la variable Parch, hay ", atip, " valores atípicos que se encuentran fuera del intervalo (",LI,",",LS,")")
```

Aquí nuevamente ocurre un fenómeno interesante. Como más del 75% de los pasajeros no tenía hijos a bordo, el método de Tukey identifica como valor atípico aquellos casos que sí tienen hijos. No obstante, los valores que posee este atributo son presumiblemente correctos, por lo que no serán eliminados. Misma política fue aplicada para la variable SibSp. 

Finalmente, revisaremos la variable Fare

```{r}
q = quantile(trainData$Fare,seq(0.25,0.75,0.25))
RIC =  q[3] - q[1]
LI = q[1] - 1.5*RIC
LS = q[3] + 1.5*RIC

atip = length(trainData$Fare[trainData$Fare<LI | trainData$Fare>LS])

paste0("Para la variable Fare, hay ", atip, " valores atípicos que se encuentran fuera del intervalo (",LI,",",LS,")")

```

En esta variable se identifican 116 valores atípicos correspondientes a los valores más altos. También se puede presumir que estos datos son identificados como atípicos pues son muy pocos los boletos que tenían un alto precio. SIn embargo no son valores erróneos y se mantendran como están.

## Identificación de valores atípicos en testData

Para el conjunto de datos de prueba, ocurren las mismas situaciones que para el conjunto de datos de entrenamiento, por lo que se tomaron las mismas decisiones de mantención de la información entregada en el dataset.

```{r}
q = quantile(testData$Age,seq(0.25,0.75,0.25))
RIC =  q[3] - q[1]
LI = q[1] - 1.5*RIC
LS = q[3] + 1.5*RIC

atip = length(testData$Age[testData$Age<LI | testData$Age>LS])

paste0("Para la variable Age, hay ", atip, " valores atípicos que se encuentran fuera del intervalo (",LI,",",LS,")")

q = quantile(testData$SibSp,seq(0.25,0.75,0.25))
RIC =  q[3] - q[1]
LI = q[1] - 1.5*RIC
LS = q[3] + 1.5*RIC

atip = length(testData$SibSp[testData$SibSp<LI | testData$SibSp>LS])

paste0("Para la variable SibSp, hay ", atip, " valores atípicos que se encuentran fuera del intervalo (",LI,",",LS,")")

q = quantile(testData$Parch,seq(0.25,0.75,0.25))
RIC =  q[3] - q[1]
LI = q[1] - 1.5*RIC
LS = q[3] + 1.5*RIC

atip = length(testData$Parch[testData$Parch<LI | testData$Parch>LS])

paste0("Para la variable Parch, hay ", atip, " valores atípicos que se encuentran fuera del intervalo (",LI,",",LS,")")

q = quantile(testData$Fare,seq(0.25,0.75,0.25))
RIC =  q[3] - q[1]
LI = q[1] - 1.5*RIC
LS = q[3] + 1.5*RIC

atip = length(testData$Fare[testData$Fare<LI | testData$Fare>LS])

paste0("Para la variable Fare, hay ", atip, " valores atípicos que se encuentran fuera del intervalo (",LI,",",LS,")")

```


### Eliminación, creación y modificación de atributos.

Se eliminarán las variables que no serán consideradas en los análisis.

```{r}
testData  <- subset( testData, select = -c(PassengerId, Cabin, Name, Ticket ) )
trainData <- subset( trainData, select = -c(PassengerId, Cabin, Name, Ticket ) )

```

Agregaremos un nuevo campo a los datos. Este campo contendrá el valor de la edad discretizada con un método simple de intervalos de igual amplitud. Algunas edades se encuentran precisadas con números decimales. Se aplicará un redondeo para tener un atributo con solo números enteros

```{r echo=TRUE, message=FALSE, warning=FALSE}
trainData["Age"] = floor(trainData["Age"])
testData["Age"] = floor(testData["Age"])
```

Y se observará nuevamente las estadísticas de esta variable en ambos conjuntos de datos para realizar correctamente la discretización.

```{r}
summary(trainData$Age)
summary(testData$Age)
```


Discretizamos con intervalos.

```{r}
trainData["Rango_Age"] = cut(trainData$Age,
                             breaks = c(-1,10,20,30,40,50,60,70,80),
                             labels = c("0-10","11-20","21-30","31-40",
                                        "41-50","51-60","61-70","71-80"))
testData["Rango_Age"]  <- cut(testData$Age,
                              breaks = c(-1,10,20,30,40,50,60,70,80),
                              labels = c("(0-10","11-20","21-30","31-40",
                                         "41-50","51-60","61-70","71-80"))
```

También se dicotomizarán las variables familiares, dejándolas simplemente en viajaba con/sin hermanos o cónyuges y viajaba con/sin hijos o padres.

```{r}
trainData$SibSp[trainData$SibSp!=0] = 1
trainData$Parch[trainData$Parch!=0] = 1
testData$SibSp[testData$SibSp!=0] = 1
testData$Parch[testData$Parch!=0] = 1

trainData$SibSp = factor(trainData$SibSp,
                         levels=c(0,1),
                         labels= c("Sin hermanos ni cónyuges",
                                   "Con hermanos o cónyuges"))
trainData$Parch = factor(trainData$Parch,
                         levels=c(0,1),
                         labels= c("Sin hijos ni padres",
                                   "Con hijos o padres"))
testData$SibSp = factor(testData$SibSp,
                        levels=c(0,1),
                        labels= c("Sin hermanos ni cónyuges",
                                  "Con hermanos o cónyuges"))
testData$Parch = factor(testData$Parch,
                        levels=c(0,1),
                        labels= c("Sin hijos ni padres",
                                  "Con hijos o padres"))


```


Finalmente, transformaremos algunas variables para que sean de tipo factor.

```{r}
trainData$Sobreviviente = factor(trainData$Survived,
                                 levels = c(0,1),
                                 labels = c("No","Sí"))
trainData$Survived = NULL
trainData$Pclass = factor(trainData$Pclass,
                          levels = c(1,2,3),
                          labels = c("Primera clase",
                                     "Segunda clase",
                                     "Tercera clase"))
trainData$Sex = factor(trainData$Sex,
                       levels = c("male","female"),
                       labels = c("Masculino", "Femenino"))
trainData$Embarked = factor(trainData$Embarked,
                            levels = c("C", "Q", "S"),
                            labels = c("Cherbourg",
                                       "Queenstown",
                                       "Southampton"))

testData$Pclass = factor(testData$Pclass,
                         levels = c(1,2,3),
                         labels = c("Primera clase",
                                    "Segunda clase",
                                    "Tercera clase"))
testData$Sex = factor(testData$Sex,
                       levels = c("male","female"),
                       labels = c("Masculino", "Femenino"))
testData$Embarked = factor(testData$Embarked,
                            levels = c("C", "Q", "S"),
                            labels = c("Cherbourg",
                                       "Queenstown",
                                       "Southampton"))
```

### Nuevo Formato de la data


```{r echo=FALSE, message=FALSE, warning=FALSE}
filasTrain  = dim(trainData)[1]
columTrain = length(trainData)
filasTest  = dim(testData)[1]
columTest  = length(testData)

```

Nuesta data **test**, ahora presenta `r filasTest` registros (filas) que se corresponden a las reseñas y `r columTest` variables (columnas) que los caracterizan.

 **Atributo**    |    **Descripción**   
-----------------|--------------------------------------------------------------------------
 **Pclass** | Clase Pasajero (1=primera Clase; 2=Segunda Clase; 3=Tercera Clase) 
 **Sex** | Sexo 
 **SibSp** | Presencia de hermanos/cónyuges a bordo 
 **Parch** | Presencia de padres/hijos a bordo 
 **Fare** | Tarifa de pasajero 
 **Embarked** | Puerto de embarque (C=Cherbourg; Q=Queenstown; S=Southampton) 
 **Rango_Age** | Rango de Edad 



Nuesta data **train**, ahora presenta `r filasTrain` registros (filas) que se corresponden a las reseñas y `r columTrain` variables (columnas) que los caracterizan.

 **Atributo**    |    **Descripción**   
-----------------|--------------------------------------------------------------------------
 **Pclass** | Clase Pasajero (1=primera Clase; 2=Segunda Clase; 3=Tercera Clase) 
 **Sex** | Sexo 
 **Age** | Edad 
 **SibSp** | Presencia de hermanos/cónyuges a bordo 
 **Parch** | Presencia de padres/hijos a bordo 
 **Fare** | Tarifa de pasajero 
 **Embarked** | Puerto de embarque (C=Cherbourg; Q=Queenstown; S=Southampton) 
 **Rango_Age** | Rango de Edad 
 **Sobreviviente** | Indica si el pasajero sobrevivió o no al accidente SI-NO


Observamos los datos discretizados.

```{r}
head(trainData)
head(testData)

```

Vemos como los datos se agrupan por segmento de edad.

```{r}
grid.newpage()

plotTrbyAge <- ggplot(trainData,aes(Rango_Age))+geom_bar() +labs(x="Rango Edad", y="Pasajero")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("blue","#008000"))+ggtitle("Datos train")

plotTebyAge <- ggplot(testData,aes(Rango_Age))+geom_bar() +labs(x="Rango Edad", y="Pasajero")+ guides(fill=guide_legend(title=""))+ scale_fill_manual(values=c("blue","#008000"))+ggtitle("Datos test")

grid.arrange(plotTrbyAge,plotTebyAge,ncol=2)

```

### Procesos de análisis visuales del juego de datos

Nos proponemos analizar las relaciones entre las diferentes variables
del juego de datos para ver si se relacionan y como.

Visualizamos la relaciones entre las variables categóricas y el atributo sobrevivencia.


```{r echo=TRUE, message=FALSE, warning=FALSE}
plotTrbySex1 <- ggplot(trainData,aes(x=Sex,fill=Sobreviviente))+geom_bar(position="fill")+ylab("Sobreviviente")+ggtitle("Relación entre las variables genero y sobrevivencia")

plotTrbySex2 <- ggplot(trainData,aes(x=Sex,fill=Sobreviviente))+geom_bar()+ylab("Sobreviviente")+ggtitle("Relación entre las variables genero y sobrevivencia")

plotTrbyAge1 <- ggplot(trainData,aes(x=Rango_Age,fill=Sobreviviente))+geom_bar(position="fill")+ylab("Sobreviviente")+ggtitle("Relación entre las variables Rango Edad y sobrevivencia")

plotTrbyAge2 <- ggplot(trainData,aes(x=Rango_Age,fill=Sobreviviente))+geom_bar()+ylab("Sobreviviente")+ggtitle("Relación entre las variables Rango Edad y sobrevivencia")

grid.arrange(plotTrbySex1,plotTrbySex2,plotTrbyAge1,plotTrbyAge2,ncol=2)

plotTrbyCla1 <- ggplot(trainData,aes(x=Pclass,fill=Sobreviviente))+geom_bar(position="fill")+ylab("Sobreviviente")+ggtitle("Relación entre las variables Pclass y sobrevivencia")

plotTrbyCla2 <- ggplot(trainData,aes(x=Pclass,fill=Sobreviviente))+geom_bar()+ylab("Sobreviviente")+ggtitle("Relación entre las variables Pclass y sobrevivencia")

plotTrbyEmb1 <- ggplot(trainData,aes(x=Embarked,fill=Sobreviviente))+geom_bar(position="fill")+ylab("Sobreviviente")+ggtitle("Relación entre las variables Puerto de Embarque y sobrevivencia")

plotTrbyEmb2 <- ggplot(trainData,aes(x=Embarked,fill=Sobreviviente))+geom_bar()+ylab("Sobreviviente")+ggtitle("Relación entre las variables Puerto de Embarque y sobrevivencia")

grid.arrange(plotTrbyCla1,plotTrbyCla2,plotTrbyEmb1,plotTrbyEmb2,ncol=2)

```


Ahora visualizaremos las variables familiares y su relación con la supervivencia.


```{r echo=TRUE, message=FALSE, warning=FALSE}
plotTrbySib1 <- ggplot(trainData,aes(x=SibSp,fill=Sobreviviente))+geom_bar(position="fill")+ylab("Sobreviviente")+ggtitle("Relación entre las variables SibSp y sobrevivencia")


plotTrbySib2 <- ggplot(trainData,aes(x=SibSp,fill=Sobreviviente))+geom_bar()+ylab("Sobreviviente")+ggtitle("Relación entre las variables SibSp y sobrevivencia")


plotTrbyPar1 <- ggplot(trainData,aes(x=Parch,fill=Sobreviviente))+geom_bar(position="fill")+ylab("Sobreviviente")+ggtitle("Relación entre las variables Parch y sobrevivencia")

plotTrbyPar2 <- ggplot(trainData,aes(x=Parch,fill=Sobreviviente))+geom_bar()+ylab("Sobreviviente")+ggtitle("Relación entre las variables Parch y sobrevivencia")

grid.arrange(plotTrbySib1,plotTrbySib2,plotTrbyPar1,plotTrbyPar2,ncol=2)


```


Por último, realizaremos un gráfico de caja para la variable Fare en cada categoría de la variable supervivencia.

```{r}
ggplot(trainData,aes(x=Sobreviviente,y=Fare))+geom_boxplot()+ylab("Precio del boleto")+ggtitle("Relación entre las variables Parch y sobrevivencia")

```

------------------------------------------------------------------------

## Conclusiones previas.

De acuerdo a los graficos obtenidos, Existe una grán posibilidad de sobrevivir, si el pasajero, es mujer, es menor de 60 años, tiene un ticket de primera clase, embarca en el puerto de Cherbourg, tiene familiares a bordo y/o si la tarifa pagada fue de mayor precio.


------------------------------------------------------------------------


## Fase de Modelado.

En esta fase se construirán y evaluarán varios modelos, se probarán
algoritmos y técnicas hasta encontrar un modelo adecuado.

Las conclusiones preliminares de la sección anterior fueron realiadas en función de la observación de los gráficos generados. No obstante, es necesario aplicar procedimientos de inferencia para determinar si las diferencias visualizadas son estadísticamente significativas. Nos concentraremos en 3 procedimientos:

1) Se realizarán pruebas para comparar las medias de la tarifa del pasajero en cada categoría de la variable supervivencia y las medias de la edad del pasajero en cada categoría de la variable supervivencia.

2) Se realizará una prueba chicuadrado para determinar dependencia entre el sexo y la sobrevivencia, entre el lugar de embarque y la sobrevivencia, y entre las variables familiares y la sobrevivencia.

3) Se entrenará un modelo de árbol de decisión para predecir la sobrevivencia de los pasajeros en función de las variables analizadas.

Respecto de la prueba de comparación de medias, es necesario en primer lugar observar si los datos son normales y homocedásticos para determinar si puede aplicarse la prueba t o, en caso de que no se satisfagan las condiciones, aplicar algún procedimiento no paramétrico.

Se evaluará la normalidad de la variable Fair en cada categoría mediante la prueba de Shapiro Wilk.

```{r}
shapiro.test(trainData$Fare[trainData$Sobreviviente=="Sí"])
shapiro.test(trainData$Fare[trainData$Sobreviviente=="No"])
```

Puede observarse que el valor p en ambos test arroja un valor muy cercano a cero. En este caso la hipótesis de normalidad es rechazada en ambos casos.

Procederemos a evaluar la homocedasticidad. Como los datos no son normales, se ha elegido en este caso la prueba de Leneve.

```{r}
leveneTest(trainData$Fare, trainData$Sobreviviente)
```

El valor p de la prueba de Leneve indica que la hipótesis nula de homocedasticidad es rechazada.

Como los datos son heterocedásticos y no normales, se realizará una prueba U de Wilcoxon - Mann - Whitney para determinar diferencia significativa entre el precio de la tarifa pagada por los sobrevivientes y quienes murieron en la tragedia.

```{r}
wilcox.test(trainData$Fare[trainData$Sobreviviente=="Sí"],
            trainData$Fare[trainData$Sobreviviente=="No"])
```

El valor p de la prueba U indica que la hipótesis de igual distribución entre ambos grupos es rechazada.

Por lo tanto, existe evidencia suficiente para descartar la hipótesis que sobrevivientes y fallecidos hayan pagado, en promedio, la misma tarifa.

Realizaremos el mismo proceso para la variable Age.

```{r}
shapiro.test(trainData$Age[trainData$Sobreviviente=="Sí"])
shapiro.test(trainData$Age[trainData$Sobreviviente=="No"])
```

La edad tampoco sigue una distribución normal. Se prueba la homocedasticidad:

```{r}
leveneTest(trainData$Age, trainData$Sobreviviente)
```

A un nivel de significancia de 0,05, los datos son heterocedásticos. Se realiza la prueba U:

```{r}
wilcox.test(trainData$Age[trainData$Sobreviviente=="Sí"],
            trainData$Age[trainData$Sobreviviente=="No"])
```

A un nivel de significancia de 0,05, existen diferencias en la distribución de la edad entre sobrevivientes y fallecidos.

Procederemos ahora a evaluar con una prueba chicuadardo la relación entre el sexo y la supervivencia

```{r}
chisq.test(trainData$Sobreviviente,trainData$Sex)
```

El valor p cercano a cero indica que se rechaza la hipótesis nula de independencia entre ambas variables. Es decir, existe relación estadísticamente significativa entre el sexo de la persona y su probabilidad de supervivencia.

Cabe destacar que en este caso es posible realizar la prueba chicuadrado, ya que los valores esperados en cada celda de la tabla de contingencia es mayor a 5:

```{r}
chisq.test(trainData$Sobreviviente,trainData$Sex)$expected
```

Por lo que no fue necesario reemplazar esta prueba por el test exacto de Fisher.

Se realiza la prueba chicuadrado para las demás variabes categóricas (para no extender este documento, se han omitido las comprobaciones sobre los valores esperados)

```{r}
chisq.test(trainData$Sobreviviente,trainData$SibSp)
chisq.test(trainData$Sobreviviente,trainData$Parch)
chisq.test(trainData$Sobreviviente,trainData$Embarked)
```

Puede observarse que se rechaza la hipótesis nula en las 3 pruebas, indicando que hay relación entre la supervivencia y las 3 variables analizadas.

Por último, entrenaremos un modelo de árbol de decisión. Cabe señalar que dadas las características categóricas de la mayoría de las variables, se optó por este procedimiento en vez de realizar una regresión logística.

```{r}
trainData2 = select(trainData,-Rango_Age)
arbol = rpart(Sobreviviente ~ ., trainData2)
rpart.plot(arbol)
```

El modelo entrenado contiene las variables sexo, edad, clase y tarifa. El árbol resultante plantea las siguientes reglas de decisión:

Sexo femenino y no es de tercera clase --> Sobrevive
Sexo femenino de tercera clase que pagó menos de 23 de tarifa y tiene menos de 25 años --> Sobrevive
Sexo masculino menor de 13 años que no es de tercera clase --> Sobrevive
Sexo masculino de tercera clase que pagó menos de 21 de tarifa --> Sobrevive

La natriz de confusión del modelo sobre los datos de entrenamiento indica que el modelo logra clasificar correctamete el 84,96% de los casos, con una sensibilidad del 94,54% y 69,59%.

```{r}
predic = predict(arbol,trainData,type="class")
confusionMatrix(predic, trainData$Sobreviviente)
```

Claramente es un modelo que puede perfeccionarse, ya sea aplicando otra técnica para crear árboles de decisión o buscando otro modelo má complejo, como redes neuronales, por ejemplo. Sin embargo, consideramos que este modelo, además de todo lo demás realizado, cumple con el objetivo de la práctica, por lo que lo aplicaremos al conjunto de prueba.


## Resolución del problema

------------------------------------------------------------------------

Se aplicará el modelo de árbol de decisión generado al conjunto de prueba. Para ello, es necesario

Como este conjunto de datos no tiene el valor real de la sobrevivencia, no podremos evaluarlo mediante una matriz de confusión, pero sí se generarán tablas de contingencia para observar las predicciones realizadas.

```{r}
testData$predic = predict(arbol, testData, type="class")
table(testData$predic)
```

Según la predicción, 119 personas del conjunto de prueba sobrevivirían y 299 no.

Los siguientes gráficos muestran la distribución de la predicción de sobrevivientes y fallecidos en las diferentes variables categóricas

```{r echo=TRUE, message=FALSE, warning=FALSE}
plotTrbySex1 <- ggplot(testData,aes(x=Sex,fill=predic))+geom_bar(position="fill")+ylab("predic")+ggtitle("Relación entre las variables genero y sobrevivencia")

plotTrbySex2 <- ggplot(testData,aes(x=Sex,fill=predic))+geom_bar()+ylab("predic")+ggtitle("Relación entre las variables genero y sobrevivencia")

plotTrbyAge1 <- ggplot(testData,aes(x=Rango_Age,fill=predic))+geom_bar(position="fill")+ylab("predic")+ggtitle("Relación entre las variables Rango Edad y sobrevivencia")

plotTrbyAge2 <- ggplot(testData,aes(x=Rango_Age,fill=predic))+geom_bar()+ylab("predic")+ggtitle("Relación entre las variables Rango Edad y sobrevivencia")

grid.arrange(plotTrbySex1,plotTrbySex2,plotTrbyAge1,plotTrbyAge2,ncol=2)

plotTrbyCla1 <- ggplot(testData,aes(x=Pclass,fill=predic))+geom_bar(position="fill")+ylab("predic")+ggtitle("Relación entre las variables Pclass y sobrevivencia")

plotTrbyCla2 <- ggplot(testData,aes(x=Pclass,fill=predic))+geom_bar()+ylab("predic")+ggtitle("Relación entre las variables Pclass y sobrevivencia")

plotTrbyEmb1 <- ggplot(testData,aes(x=Embarked,fill=predic))+geom_bar(position="fill")+ylab("predic")+ggtitle("Relación entre las variables Puerto de Embarque y sobrevivencia")

plotTrbyEmb2 <- ggplot(testData,aes(x=Embarked,fill=predic))+geom_bar()+ylab("predic")+ggtitle("Relación entre las variables Puerto de Embarque y sobrevivencia")

grid.arrange(plotTrbyCla1,plotTrbyCla2,plotTrbyEmb1,plotTrbyEmb2,ncol=2)

plotTrbySib1 <- ggplot(testData,aes(x=SibSp,fill=predic))+geom_bar(position="fill")+ylab("predic")+ggtitle("Relación entre las variables SibSp y sobrevivencia")


plotTrbySib2 <- ggplot(testData,aes(x=SibSp,fill=predic))+geom_bar()+ylab("predic")+ggtitle("Relación entre las variables SibSp y sobrevivencia")


plotTrbyPar1 <- ggplot(testData,aes(x=Parch,fill=predic))+geom_bar(position="fill")+ylab("predic")+ggtitle("Relación entre las variables Parch y sobrevivencia")

plotTrbyPar2 <- ggplot(testData,aes(x=Parch,fill=predic))+geom_bar()+ylab("predic")+ggtitle("Relación entre las variables Parch y sobrevivencia")

grid.arrange(plotTrbySib1,plotTrbySib2,plotTrbyPar1,plotTrbyPar2,ncol=2)

```

Puede visualizarse que el modelo predice que los sobrevivientes serán principalmente mujeres, menores de 20 años, que poseen boletos de primera clase, con familiares a bordo y/o que o embarcaron en Queenstown.

Finalmente, exportaremos ambos dataframes en archivos csv

```{r}
write.csv(trainData,"trainMod.csv")
write.csv(testData,"testMod.csv")
```


## Tabla de contribuciones







